import os
import wmi
import psutil
import time
import requests


os.system(r"D:\file.bat")

def remove_spaces(s):
    n = len(s)
    s1 = ''
    for i in range(n):
        if s[i] != ' ':
            s1 += s[i]
        elif s[i]== ' ':
            if s[i + 1] != ' ':
                s1 += s[i]
    return s1


with open('D:\output.txt') as file:
    temp = []
    IP =  []
    PID = []
    for line in file:
        e = ''
        
        if line[0:2] == '  ' and (line[2:5] == 'TCP' or line[2:5] == 'UDP'):
            e = remove_spaces(line)
            temp.append(e)


l = len(temp)
for i in range(l):
    
    a = temp[i].split(' ')
    if a[4] == 'LISTENING' or a[4] == 'ESTABLISHED':
        IP.append(a[3])
        PID.append(a[-1])


PID_new = []
for x in PID:
    if x not in PID_new:
        PID_new.append(x)


c = wmi.WMI()

l = len(PID_new)
path = []
for i in range(l):
    process = psutil.Process(int(PID_new[i]))
    process_name = process.name()
    
    for process in c.Win32_Process(name=process_name):
        
        if process.ExecutablePath:
            path.append(process.ExecutablePath)
        break    

API_KEY = 'INSERT_API_KEY_HERE'   #could be received from VirusTotal Website


l = len(path)
for i in range(l):
    if i % 2 == 0 and i != 0:
        time.sleep(60)
        
    url = 'https://www.virustotal.com/vtapi/v2/file/scan'

    params = {'apikey': API_KEY}

    files = {'file': (path[i], open(path[i], 'rb'))}

    response = requests.post(url, files=files, params=params)
    p = response.json()
    r = p['resource']
    
    url = 'https://www.virustotal.com/vtapi/v2/file/report'
    params = {'apikey': API_KEY, 'resource': r}

    response = requests.get(url, params=params)
    res = response.json()
    
    if res['positives'] > 0:
        print(res)
        a = path[i]
        for process in psutil.process_iter():
            if process.name() == a:
                process.kill()
